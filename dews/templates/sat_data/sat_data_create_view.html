{% extends 'base.html' %}
{% load static %}

{% block header %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock %}

{% block title %}
  DEWS DataHub - Create Sat Data Entry
{% endblock %}

{% block content %}
  <section class="jumbotron text-center">
    <div class="container pt-1 pb-1">
      <h1 class="display-4 font-italic text-center">Create SatData Entry</h1>
      <p class="lead text-muted">
        Here you can upload a satellite data archive file which you downloaded from <a href="https://browser.dataspace.copernicus.eu/">Dataspace Copernicus</a> <b><i>or</i></b> select a bounding box by using the map.<br />
        The mission, band image paths, coordinates, etc. will automatically be recognized and you will find these info in the sat data entry after the upload and when the processing is done.
      </p>
    </div>
  </section>
  <hr class="light-100" />

  <!-- Upload form -->
  <div class="container mt-5">
    <div class="row">
      <!-- Headline -->
      <h2 class="display-6 text-center">Upload archive</h2>

      <div class="col-md-4"></div>

      <div class="col-md-4">
        <!-- Upload form -->
        <form action="." method="POST" enctype="multipart/form-data" id="sat_data_form">
          {% csrf_token %}
          <!-- Archive upload form -->
          {{ sat_data_form.as_p }}
          <!-- Upload button -->
          <button type="submit" class="btn btn-outline-success"><i class="fa-solid fa-upload"></i> Upload archive</button>
        </form>
        <!-- Error message -->
        {% if error %}
          <div class="alert alert-danger" role="alert">{{ error }}</div>
        {% endif %}
        <!-- Success message -->
        {% if success %}
          <div class="alert alert-success" role="alert">
            <div class="row">
              {{ success }} <i class="fa-solid fa-check"></i>
            </div>
            <div class="row">
              <a href="{% url 'overview_view' %}" class="btn btn-success"><i class="fa-solid fa-table-columns"></i> Show overview</a>
            </div>
          </div>
        {% endif %}
      </div>

      <div class="col-md-4"></div>
    </div>

    <hr class="light-100" />

    <div class="row">
      <h2 class="display-6 text-center">Request via API</h2>

      <form method="post" id="sh_form">
        {% csrf_token %}
        {{ sh_form.as_p }}
        <div class="col-md-12">
          <div id="map" style="height: 600px;"></div>
          <button type="submit" class="btn btn-outline-success">Submit Form</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Leaflet map script -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script type="text/javascript">
    function boundingBoxToWKT(coordString) {
      const coords = coordString.split(',').map(Number)
      const minLon = coords[0]
      const minLat = coords[1]
      const maxLon = coords[2]
      const maxLat = coords[3]
    
      // Construct the WKT string for the polygon
      // Note: The vertices are defined in a specific order to enclose the area correctly.
      const wkt = `POLYGON ((${minLon} ${minLat}, ${maxLon} ${minLat}, ${maxLon} ${maxLat}, ${minLon} ${maxLat}, ${minLon} ${minLat}))`
    
      return wkt
    }
    
    var map = L.map('map').setView([51.1657, 10.4515], 6) // Centered on Germany
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map)
    
    var drawnItems = new L.FeatureGroup()
    map.addLayer(drawnItems)
    
    var drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems
      },
      draw: {
        polygon: false,
        polyline: false,
        rectangle: true,
        circle: false,
        marker: false
      }
    })
    map.addControl(drawControl)
    
    let coordinates = null
    
    map.on(L.Draw.Event.CREATED, function (e) {
      var type = e.layerType,
        layer = e.layer
    
      if (type === 'rectangle') {
        drawnItems.clearLayers()
    
        drawnItems.addLayer(layer)
    
        coordinates = layer.getBounds().toBBoxString()
        document.querySelector('input[name="coordinates"]').value = boundingBoxToWKT(coordinates)
      }
    })
    
    document.addEventListener('DOMContentLoaded', function () {
      var circlemarkerControl = document.querySelector('.leaflet-draw-draw-circlemarker')
      if (circlemarkerControl) {
        circlemarkerControl.style.display = 'none'
      }
    })
  </script>

  <!-- Automatic bands selection -->
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
      // Listen for changes on each metrics_to_calc checkbox
      document.querySelectorAll('input[name="metrics_to_calc"]').forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
          // Only proceed if the checkbox is checked
          if (!checkbox.checked) {
            return
          }
    
          // Check if NDVI is selected
          const ndviCheckbox = document.querySelector('input[id="id_metrics_to_calc_0"]')
          const ndwiCheckbox = document.querySelector('input[id="id_metrics_to_calc_1"]')
          const eviCheckbox = document.querySelector('input[id="id_metrics_to_calc_2"]')
          const smiCheckbox = document.querySelector('input[id="id_metrics_to_calc_3"]')
          const rgbCheckbox = document.querySelector('input[id="id_metrics_to_calc_4"]')
          const isNdviSelected = ndviCheckbox.checked
          const isNdwiSelected = ndwiCheckbox.checked
          const isEviSelected = eviCheckbox.checked
          const isSmiSelected = smiCheckbox.checked
          const isRgbSelected = rgbCheckbox.checked
    
          // Find checkboxes
          const bandB01Checkbox = document.querySelector('input[value="B01"]')
          const bandB02Checkbox = document.querySelector('input[value="B02"]')
          const bandB03Checkbox = document.querySelector('input[value="B03"]')
          const bandB04Checkbox = document.querySelector('input[value="B04"]')
          const bandB05Checkbox = document.querySelector('input[value="B05"]')
          const bandB06Checkbox = document.querySelector('input[value="B06"]')
          const bandB07Checkbox = document.querySelector('input[value="B07"]')
          const bandB08Checkbox = document.querySelector('input[value="B08"]')
          const bandB8aCheckbox = document.querySelector('input[value="B8A"]')
          const bandB09Checkbox = document.querySelector('input[value="B09"]')
          const bandB10Checkbox = document.querySelector('input[value="B10"]')
          const bandB11Checkbox = document.querySelector('input[value="B11"]')
          const bandB12Checkbox = document.querySelector('input[value="B12"]')
    
          if (isNdviSelected) {
            if (bandB04Checkbox) bandB04Checkbox.checked = true
            if (bandB08Checkbox) bandB08Checkbox.checked = true
          }
          if (isNdwiSelected) {
            if (bandB03Checkbox) bandB03Checkbox.checked = true
            if (bandB08Checkbox) bandB08Checkbox.checked = true
          }
          if (isEviSelected) {
            if (bandB02Checkbox) bandB02Checkbox.checked = true
            if (bandB04Checkbox) bandB04Checkbox.checked = true
            if (bandB8aCheckbox) bandB8aCheckbox.checked = true
          }
          if (isSmiSelected) {
            if (bandB8aCheckbox) bandB8aCheckbox.checked = true
            if (bandB11Checkbox) bandB11Checkbox.checked = true
          }
          if (isRgbSelected) {
            if (bandB02Checkbox) bandB02Checkbox.checked = true
            if (bandB03Checkbox) bandB03Checkbox.checked = true
            if (bandB04Checkbox) bandB04Checkbox.checked = true
          }
        })
      })
    })
  </script>
{% endblock %}
